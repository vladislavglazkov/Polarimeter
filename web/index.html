<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Page Title</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <script src="cbor.js" type="text/javascript"></script>
    <script>
class Base64{
    static encode(array) {
        let arr=new Uint8Array(array);
        let str='';
        //alert(arr.length);
        arr.forEach(element=>{str=str+String.fromCharCode(element)});
        //alert(str.length);
        return btoa(str);
    }
    static decode(string){
        let uar=new Uint8Array(atob(string).length);
        let i=0;
        atob(string).split('').map(c=>{uar[i]=c.charCodeAt(0);i++;});
        return uar;
    }
}
function arrayBufferToStr(buf) {
    return String.fromCharCode.apply(null, new Uint8Array(buf));
}
async function getKey(){
    async function process(idb,res){
      async function last(res,req){
          res(req.result);
      }
        let db=idb.result;
        let ans=db.transaction(["crypto"],"readonly").objectStore("crypto").get("key");
        ans.onsuccess=last.bind(this,res,ans);
        
    }
    let idb=indexedDB.open("db");
    let res;
    let pr=new Promise ((resolve,reject)=>{res=resolve});
    idb.onsuccess=process.bind(this,idb,res);
    return await pr;
  }



        async function f1(){
            let challenge=new Uint8Array(20);
            window.crypto.getRandomValues(challenge);
            const publicKey = {
                challenge:challenge,
                rp: {
    name: "Example CORP",
    id  : "localhost"
  },
  user: {
    id:new Uint8Array([1,3,2]).buffer,
    name: "jdoe@example.com",
    displayName: "John Doe"
  },
  
  attestaion:"direct",
  pubKeyCredParams: [
    {
      type: "public-key",
      alg: -7
    },
    {
      type: "public-key",
      alg: -35
    },
    {
      type: "public-key",
      alg: -36
    },
    {
      type: "public-key",
      alg: -257
    },
    {
      type: "public-key",
      alg: -258
    },
    {
      type: "public-key",
      alg: -259
    },
    {
      type: "public-key",
      alg: -37
    },
    {
      type: "public-key",
      alg: -38
    },
    {
      type: "public-key",
      alg: -39
    },
    {
      type: "public-key",
      alg: -8
    }
  ],
  authenticatorSelection:{
    userVerification:"discouraged"
  },
  extensions:{
    txAuthSimple:""
  }
};
console.log(challenge);
let res=await navigator.credentials.create({publicKey});
console.log(res);
let cdj=res.response.clientDataJSON;
let obj=JSON.parse(arrayBufferToStr(cdj));

console.log(obj);

let att=CBOR.decode(res.response.attestationObject);
console.log(att);
let adata=att.authData;
let credlen=adata.slice(53,55);
let cl=credlen[0]+credlen[1]*256;
console.log(cl);
let ar=new DataView(new Uint8Array(2).buffer);
ar.setUint8(0,credlen[0]);
ar.setUint8(1,credlen[1]);
cl=ar.getUint16();
console.log(cl);
console.log("Alleged key");
let allegedKey=adata.slice(55+cl);
console.log(allegedKey);


let pkey=res.response.getPublicKey();
console.log('This is legit public key');
console.log(pkey);
let kobj=CBOR.decode(allegedKey.buffer);
console.log(kobj);
let send=new Object();
send.CredentialId=res.id;
if (kobj[1]==3){
  
  send.type="RSA";
  send.pubMod=Array.from(kobj[-1]);
  send.pubExp=Array.from(kobj[-2]);
  send.algid=kobj[3];
}
if (kobj[1]==2){
  send.type="ECDsa";
  send.algid=kobj[-1];
  send.pubX=Array.from(kobj[-2]);
  send.pubY=Array.from(kobj[-3]);

}
fetch("http://localhost:5005/api/attest",{
  method:"POST",
  body:JSON.stringify(send),
  headers:{
    "Content-Type":"application/json"
  }
});

let elm=document.createElement("a");
elm.href=link;
elm.download="crt.der";
//elm.click();
        }

        
        function Base64Url(input) {
        // Replace non-url compatible chars with base64 standard chars
        input = input
            .replace(/-/g, '+')
            .replace(/_/g, '/');

        // Pad out with standard base64 required padding characters
        var pad = input.length % 4;
        if(pad) {
          if(pad === 1) {
            throw new Error('InvalidLengthError: Input base64url string is the wrong length to determine padding');
          }
          input += new Array(5-pad).join('=');
        }

        return input;
    }

async function f2(){
    let params=await (await fetch("http://localhost:5005/api/autest")).json();
  
    let challenge=Base64.decode(params.challenge);
    challenge[0]=44;
    let avlbK=[];
    params.keys.forEach(element=>{
      avlbK.push({type:"public-key",id:Base64.decode(Base64Url(element))});

    });
    console.log(avlbK);
    console.log(challenge);
    console.log("challenge");

    const publicKey = {
                challenge:challenge,
                rp: {
    name: "Example CORP",
    id  : "localhost"
  },
  user: {
    id:new Uint8Array([1,3,2]).buffer,
    name: "jdoe@example.com",
    displayName: "John Doe"
    },
    userVerification:"discouraged",
    allowCredentials:avlbK,
  pubKeyCredParams: [
    {
      type: "public-key",
      alg: -7
    },
    
    {
      type: "public-key",
      alg: -257
    },
    
    {
      type: "public-key",
      alg: -37
    },
    

  ],

  authenticatorSelection:{
    
  },
  extensions:{
    txAuthSimple:""
  }
};
console.log(publicKey);
let res=await navigator.credentials.get({publicKey:publicKey});
console.log(res);
let userData=arrayBufferToStr( res.response.clientDataJSON);
console.log(userData);
let userDataObj=JSON.parse(userData);
userDataObj.challenge=Array.from(Base64.decode(Base64Url(userDataObj.challenge)));
let obj={
  Signature:Array.from(new Uint8Array(res.response.signature)),
  UserData:JSON.stringify(userDataObj),
  OrigUserData:userData,
  AuthenticatorData:Array.from(new Uint8Array(res.response.authenticatorData)),
  CredentialId:res.id
};
fetch("http://localhost:5005/api/autest",{
  method:"POST",
  body:JSON.stringify(obj),
  headers:{
    "Content-Type":"application/json"
  }
})


}

    </script>
</head>
<body>
    <button onclick="f1()">CREATE</button><br>
    <button onclick="f2()">VERIFY</button>

</body>
</html>